// main.js

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
// window.currentCategory = '–≤—Å–µ'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ loadCategoriesAndSetupFilters

document.addEventListener('DOMContentLoaded', async () => {
  console.log(">>> [DEBUG] DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è");

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π (–¥–ª—è –ø–æ–∏—Å–∫–∞, –∫–æ—Ä–∑–∏–Ω—ã, –º–æ–¥–∞–ª–æ–∫ –∏ —Ç.–¥.)
  // –≠—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  setupEventListeners();

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Å–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  // –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤
  await loadCategoriesAndSetupFilters();

  // updateCartCount(); // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∑–¥–µ—Å—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Å—Ä–∞–∑—É
  // –ù–æ loadCategoriesAndSetupFilters -> renderProducts —É–∂–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–Ω–¥–µ—Ä,
  // –∞ updateCartCount –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ addToCart/clearCart
});

// --- –û—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à –∫–æ–¥ –∏–∑ main.js, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å --- // ui.js

// DOM-—ç–ª–µ–º–µ–Ω—Ç—ã
const productsContainer = document.getElementById('products');
const searchInput = document.getElementById('search-input');
let categoryButtons = []; // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫
const cartBtn = document.getElementById('cart-btn');
const cartModal = document.getElementById('cart-modal');
const productModal = document.getElementById('product-modal');
const cartItems = document.getElementById('cart-items');
const phoneInput = document.getElementById('phone-input');
const commentInput = document.getElementById('comment-input');
const sendOrderBtn = document.getElementById('send-order');
const successMessage = document.getElementById('success-message');
const yearSpan = document.getElementById('year');
let renderProductsTimeout;

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –∏–∑ localStorage
function getCart() {
    const cart = localStorage.getItem('cart');
    return cart ? JSON.parse(cart) : [];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
function addToCart(product) {
    if (!product || !product.id) {
        console.error('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä: –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', product);
        return;
    }
    const cart = getCart();
    const existingItemIndex = cart.findIndex(item => item.product.id === product.id);

    if (existingItemIndex > -1) {
        cart[existingItemIndex].qty += 1;
    } else {
        cart.push({ product: product, qty: 1 });
    }

    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartCount();
    console.log(`–¢–æ–≤–∞—Ä ${product.title} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
function updateQuantity(productId, change) {
    const cart = getCart();
    const itemIndex = cart.findIndex(item => item.product.id === productId);

    if (itemIndex !== -1) {
        cart[itemIndex].qty += change;
        if (cart[itemIndex].qty <= 0) {
            cart.splice(itemIndex, 1); // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ <= 0
        }
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCount();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã
function clearCart() {
    localStorage.removeItem('cart');
    updateCartCount();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ (–ø—Ä–∏–º–µ—Ä)
function updateCartCount() {
    const cartCountElement = document.getElementById('cart-count'); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π ID
    if (cartCountElement) {
        const count = getCart().reduce((total, item) => total + item.qty, 0);
        cartCountElement.textContent = count > 0 ? count : '';
        // cartCountElement.style.display = count > 0 ? 'inline' : 'none';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
function formatPrice(priceInCents) {
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ü–µ–Ω–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–æ–ø–µ–π–∫–∞—Ö/—Ü–µ–Ω—Ç–∞—Ö
    const priceInRubles = priceInCents / 100;
    return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB' }).format(priceInRubles);
}

// --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–¥–∞ ---
if (yearSpan) {
    yearSpan.textContent = new Date().getFullYear();
}

// --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π ---

// 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
async function loadCategoriesAndSetupFilters() {
    const tagsContainer = document.querySelector('.tags');
    if (!tagsContainer) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–≥–æ–≤ (.tags) –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
        // –î–∞–∂–µ –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        window.currentCategory = '–≤—Å–µ';
        renderProducts(); // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Ä–µ–Ω–¥–µ—Ä —Å –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
        return;
    }

    try {
        const res = await fetch('/api/categories');
        if (!res.ok) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ.');
            throw new Error('Categories fetch failed');
        }
        let categories = await res.json();
        console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:', categories);

        // --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
        // 1. –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–≤—Å–µ"
        const allCategory = { slug: '–≤—Å–µ', name: '–≤—Å–µ' };
        // 2. –§–∏–ª—å—Ç—Ä—É–µ–º, —á—Ç–æ–±—ã "–≤—Å–µ" –Ω–µ –±—ã–ª–æ –≤ —Å–ø–∏—Å–∫–µ –∏–∑ API (–µ—Å–ª–∏ –æ–Ω–æ —Ç–∞–º –µ—Å—Ç—å)
        categories = categories.filter(cat => cat.slug !== '–≤—Å–µ');
        // 3. –°—Ç–∞–≤–∏–º "–≤—Å–µ" –≤ –Ω–∞—á–∞–ª–æ
        categories.unshift(allCategory);

        // --- –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
        renderCategoryButtons(categories, tagsContainer);

        // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ---
        setupCategoryEventListeners();

        // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
        // window.currentCategory —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ main.js –∫–∞–∫ '–≤—Å–µ'
        // –ù–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏–º
        window.currentCategory = '–≤—Å–µ';
        console.log("–ù–∞—á–∞–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:", window.currentCategory);

        // --- –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ ---
        renderProducts();

    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
        // --- Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
        const defaultCategories = [
            { slug: '–≤—Å–µ', name: '–≤—Å–µ' },
            { slug: 'headset', name: '—à–ª–µ–º—ã' },
            { slug: 'accessory', name: '–∫—Ä–µ–ø–ª–µ–Ω–∏—è' },
            { slug: 'battery', name: '–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã' },
            { slug: 'charger', name: '–¥–æ–∫-—Å—Ç–∞–Ω—Ü–∏–∏' }
        ];
        renderCategoryButtons(defaultCategories, tagsContainer);
        setupCategoryEventListeners();

        window.currentCategory = '–≤—Å–µ';
        renderProducts();
    }
}

// 2. –†–µ–Ω–¥–µ—Ä –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ DOM
function renderCategoryButtons(categories, container) {
    container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'tag-btn';
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–≤—Å–µ" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–∫—É—â—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        if (cat.slug === '–≤—Å–µ' || cat.slug === window.currentCategory) {
            btn.classList.add('active');
        }
        btn.dataset.category = cat.slug; // –ò—Å–ø–æ–ª—å–∑—É–µ–º slug –¥–ª—è data-–∞—Ç—Ä–∏–±—É—Ç–∞
        btn.textContent = cat.name;
        container.appendChild(btn);
    });
    console.log("–ö–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ DOM");
}

// 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function setupCategoryEventListeners() {
    // –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
    const buttons = document.querySelectorAll('.tag-btn');
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${buttons.length} –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤`);

    buttons.forEach(btn => {
        // –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
        // –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
        const newBtn = btn.cloneNode(true); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        btn.parentNode.replaceChild(newBtn, btn); // –ó–∞–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –Ω–∞ –Ω–æ–≤—É—é

        newBtn.addEventListener('click', () => {
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'active' —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'active' —Ç–æ–ª—å–∫–æ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
            newBtn.classList.add('active');

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
            const selectedCategory = newBtn.dataset.category;
            if (selectedCategory !== undefined) {
                window.currentCategory = selectedCategory;
                console.log("–í—ã–±—Ä–∞–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è:", window.currentCategory);
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                renderProducts();
            } else {
                console.error("–£ –∫–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç data-category –∞—Ç—Ä–∏–±—É—Ç:", newBtn);
            }
        });
    });
    console.log("–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
}

// --- –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π ---
async function renderProducts() {
    // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç —Ä–µ–Ω–¥–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (debounce)
    if (renderProductsTimeout) {
        clearTimeout(renderProductsTimeout);
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç
    renderProductsTimeout = setTimeout(async () => {
        try {
            // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
            const res = await fetch('/api/products');
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            const PRODUCTS = await res.json();
            console.log("–¢–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞:", PRODUCTS.length, "—à—Ç.");

            // 2. –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const query = (searchInput?.value || '').toLowerCase().trim();
            const currentCategory = window.currentCategory; // –ü–æ–ª—É—á–∞–µ–º –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

            console.log("–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã: –ø–æ–∏—Å–∫ =", query, ", –∫–∞—Ç–µ–≥–æ—Ä–∏—è =", currentCategory);

            // 3. –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
            const filteredProducts = PRODUCTS.filter(p => {
                const isAvailable = p.available !== false; // –°—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º, –µ—Å–ª–∏ available === true –∏–ª–∏ undefined

                // --- –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ---
                const categoryMatch = currentCategory === '–≤—Å–µ' || p.category === currentCategory;
                // console.log(`–¢–æ–≤–∞—Ä ${p.id}: –∫–∞—Ç–µ–≥–æ—Ä–∏—è '${p.category}' —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å '${currentCategory}'?`, categoryMatch);

                // --- –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É ---
                const searchMatch =
                    query === '' ||
                    (p.title && p.title.toLowerCase().includes(query)) ||
                    (p.description && p.description.toLowerCase().includes(query));

                // –¢–æ–≤–∞—Ä –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –ò –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ò –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ –ø–æ–∏—Å–∫—É
                return isAvailable && categoryMatch && searchMatch;
            });

            console.log("–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:", filteredProducts);

            // 4. –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –≤ DOM
            if (productsContainer) {
                productsContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

                if (filteredProducts.length === 0) {
                    productsContainer.innerHTML = '<p class="no-products">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                    return;
                }

                filteredProducts.forEach(p => {
                    const productEl = document.createElement('div');
                    productEl.className = 'product';
                    // --- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ HTML –ø–æ–¥ –≤–∞—à—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É ---
                    productEl.innerHTML = `
                        <img src="${p.images && p.images[0] ? p.images[0].url.trim() : '/path/to/default-image.jpg'}" alt="${p.title || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'}" />
                        <h3>${p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                        <p class="product-description">${p.description || ''}</p>
                        <div class="product-price">${formatPrice(p.price)}</div>
                        <button class="view-btn" data-product-id="${p.id}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
                        <button class="add-btn" data-product-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    `;
                    productsContainer.appendChild(productEl);

                    // --- –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ ---
                    productEl.querySelector('.view-btn')?.addEventListener('click', () => {
                        // –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        openProductModal(p);
                    });

                    productEl.querySelector('.add-btn')?.addEventListener('click', () => {
                        addToCart(p);
                    });
                });
            }

        } catch (err) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ —Ç–æ–≤–∞—Ä–æ–≤:', err);
            if (productsContainer) {
                productsContainer.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>';
            }
        }
    }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300ms –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º (debounce)
}

// --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ---
function openProductModal(product) {
    // --- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ –≤–∞—à—É —Ä–∞–∑–º–µ—Ç–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
    const titleEl = document.getElementById('product-title');
    const descEl = document.getElementById('product-description');
    const priceEl = document.getElementById('product-price');
    const mainImgEl = document.getElementById('product-main-image');
    const thumbnailsEl = document.getElementById('thumbnails');

    if (titleEl) titleEl.textContent = product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    if (descEl) descEl.textContent = product.description || '';
    if (priceEl) priceEl.textContent = formatPrice(product.price);
    if (mainImgEl) {
        mainImgEl.src = product.images && product.images[0] ? product.images[0].url.trim() : '';
        mainImgEl.alt = product.title || '';
    }

    if (thumbnailsEl) {
        thumbnailsEl.innerHTML = '';
        if (product.images && product.images.length > 1) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—ã, –µ—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π
            product.images.forEach((img, index) => {
                const thumb = document.createElement('img');
                thumb.src = img.url.trim();
                thumb.alt = img.alt || `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${index + 1} —Ç–æ–≤–∞—Ä–∞ ${product.title}`;
                thumb.className = 'thumbnail';
                if (index === 0) thumb.classList.add('active');

                thumb.addEventListener('click', () => {
                    if (mainImgEl) mainImgEl.src = img.url.trim();
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                });

                thumbnailsEl.appendChild(thumb);
            });
        }
    }

    window.currentProduct = product; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä –≥–ª–æ–±–∞–ª—å–Ω–æ
    if (productModal) productModal.classList.add('open');
}

function openCartModal() {
    // --- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ –≤–∞—à—É —Ä–∞–∑–º–µ—Ç–∫—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã ---
    if (cartItems) {
        const cart = getCart();
        cartItems.innerHTML = '';

        if (cart.length === 0) {
            cartItems.innerHTML = '<div class="empty">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>';
        } else {
            let total = 0;
            cart.forEach(item => {
                const row = document.createElement('div');
                row.className = 'cart-item';
                row.innerHTML = `
                    <img src="${item.product.images && item.product.images[0] ? item.product.images[0].url.trim() : ''}" alt="${item.product.title || ''}" />
                    <div class="cart-item-info">
                        <div class="cart-item-title">${item.product.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                        <div class="cart-item-price">${formatPrice(item.product.price)}</div>
                        <div class="cart-quantity">
                            <button class="qty-minus" data-product-id="${item.product.id}">‚àí</button>
                            <span>${item.qty}</span>
                            <button class="qty-plus" data-product-id="${item.product.id}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-total">${formatPrice(item.product.price * item.qty)}</div>
                `;
                cartItems.appendChild(row);
                total += item.product.price * item.qty;
            });

            const totalRow = document.createElement('div');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `<span>–ò—Ç–æ–≥–æ:</span><span>${formatPrice(total)}</span>`;
            cartItems.appendChild(totalRow);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            cartItems.querySelectorAll('.qty-minus').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.productId);
                    if (!isNaN(id)) {
                        updateQuantity(id, -1);
                        openCartModal(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                    }
                });
            });

            cartItems.querySelectorAll('.qty-plus').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.productId);
                    if (!isNaN(id)) {
                        updateQuantity(id, 1);
                        openCartModal(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
                    }
                });
            });
        }
    }

    updateSendOrderButton();
    if (cartModal) cartModal.classList.add('open');
}

function closeModals() {
    const openModal = document.querySelector('.modal.open');
    if (openModal) openModal.classList.remove('open');
}

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ ---
function updateSendOrderButton() {
    if (!sendOrderBtn) return;
    if (getCart().length === 0) {
        sendOrderBtn.disabled = true;
        sendOrderBtn.title = '–ù–µ–ª—å–∑—è –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Äî –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
    } else {
        sendOrderBtn.disabled = false;
        sendOrderBtn.title = '';
    }
}

// --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π ---
function setupEventListeners() {

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ ---
    if (searchInput) {
        // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–∂–µ
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderProducts(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –ø–æ–∏—Å–∫
            }, 300);
        });
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –∏ –∫–æ—Ä–∑–∏–Ω—ã ---
    if (cartBtn) {
        cartBtn.addEventListener('click', openCartModal);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–æ–∫
    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', closeModals);
    });

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∑–∞–∫–∞–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å) ---
    if (phoneInput) {
        phoneInput.addEventListener('input', () => {
            phoneInput.value = phoneInput.value.replace(/[^0-9+]/g, '');
        });
    }

    if (sendOrderBtn) {
        let isSending = false;
        sendOrderBtn.addEventListener('click', async () => {
            if (isSending) return;
            if (!phoneInput || !phoneInput.value.trim()) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
                return;
            }
            if (getCart().length === 0) {
                alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
                return;
            }

            try {
                isSending = true;
                sendOrderBtn.disabled = true;
                sendOrderBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phoneInput.value,
                        comment: commentInput ? commentInput.value : '',
                        cart: getCart()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    clearCart();
                    if (phoneInput) phoneInput.value = '';
                    if (commentInput) commentInput.value = '';
                    if (successMessage) successMessage.style.display = 'block';
                    updateCartCount();
                    openCartModal(); // –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª–∫—É –∫–æ—Ä–∑–∏–Ω—ã

                    setTimeout(() => {
                        if (successMessage) successMessage.style.display = 'none';
                        sendOrderBtn.disabled = false;
                        sendOrderBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                        isSending = false;
                    }, 3000);
                } else {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º.');
                sendOrderBtn.disabled = false;
                sendOrderBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                isSending = false;
            }
        });
    }

    console.log("–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
}

// --- –≠–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü–∏–π –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ ---
window.renderProducts = renderProducts;
window.openProductModal = openProductModal;
window.openCartModal = openCartModal;
window.closeModals = closeModals;
window.setupEventListeners = setupEventListeners;
window.loadCategoriesAndSetupFilters = loadCategoriesAndSetupFilters; // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
// –¢–∞–∫–∂–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
window.getCart = getCart;
window.addToCart = addToCart;
window.updateQuantity = updateQuantity;
window.clearCart = clearCart;
window.updateCartCount = updateCartCount;
window.formatPrice = formatPrice;

console.log("[DEBUG] –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ window");// server.js
require('dotenv').config();
const express = require('express');
const path = require('path');
const fs = require('fs');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

const bcrypt = require('bcryptjs');

app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î (—Ç–æ–ª—å–∫–æ –Ω–∞ Render) ===
let pool;
if (process.env.DATABASE_URL) {
  const { Pool } = require('pg');
  pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
      rejectUnauthorized: false
    }
  });
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
process.env.TZ = 'Europe/Moscow';

// === API: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä—ã ===
app.get('/api/products', async (req, res) => {
  try {
    if (pool) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
      const isAdmin = req.query.admin === 'true';
      
      let query = `
        SELECT 
          id, title, description, price, tag, available, category, brand, compatibility,
          images_json as images
        FROM products 
      `;
      
      // –¢–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
      // –î–ª—è –∞–¥–º–∏–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
      if (!isAdmin) {
        query += 'WHERE available = true ';
      }
      
      query += 'ORDER BY id';
      
      const result = await pool.query(query);
      res.json(result.rows);
    } else {
      console.warn('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏–ª–∏ pool –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.');
      res.json([]);
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã' });
  }
});

// === API: –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ===
app.post('/api/order', async (req, res) => {
  console.log('=== –ù–ê–ß–ê–õ–û –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–ö–ê–ó–ê ===');
  console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', req.body);

  const { phone, comment, cart } = req.body;

  // 1. –ë–∞–∑–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  if (!phone || !cart || cart.length === 0) {
    console.log('–û–®–ò–ë–ö–ê: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');
    return res.status(400).json({ success: false, error: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö' });
  }

  // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
  const requestHash = JSON.stringify({ phone, comment, cart });
  if (req.app.locals.lastOrderRequest === requestHash) {
    console.log('–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
    return res.status(200).json({ 
      success: true, 
      message: '–ó–∞–∫–∞–∑ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è',
      orderId: req.app.locals.lastOrderId || null
    });
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö—ç—à –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  req.app.locals.lastOrderRequest = requestHash;
  
  // –û—á–∏—â–∞–µ–º —Ö—ç—à —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
  setTimeout(() => {
    if (req.app.locals.lastOrderRequest === requestHash) {
      req.app.locals.lastOrderRequest = null;
      req.app.locals.lastOrderId = null;
    }
  }, 30000);

  let orderId = null;
  let orderSaved = false;
  let telegramSent = false;

  try {
    // 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
    const total = cart.reduce((sum, item) => sum + (item.product?.price || 0) * item.qty, 0);
    console.log('–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è —Å—É–º–º–∞:', total);

    // 4. –ü–æ–ª—É—á–∞–µ–º –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î –∏ Telegram
    const moscowTimeObj = new Date(new Date().toLocaleString("en-US", {timeZone: 'Europe/Moscow'}));
    const moscowTimeString = moscowTimeObj.toLocaleString('ru-RU', {
      timeZone: 'Europe/Moscow',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    console.log('–í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞ (–ú–æ—Å–∫–≤–∞):', moscowTimeString);

    // 5. –í—Å—Ç–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ –≤ –ë–î
    if (pool) {
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –ë–î...');
      const orderResult = await pool.query(
        'INSERT INTO orders (phone, comment, total_amount, created_at) VALUES ($1, $2, $3, $4) RETURNING id',
        [phone, comment || '', total, moscowTimeObj]
      );
      orderId = orderResult.rows[0].id;
      orderSaved = true;
      req.app.locals.lastOrderId = orderId;
      console.log('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î —Å ID:', orderId);
    } else {
      console.warn('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ó–∞–∫–∞–∑ –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î.');
    }

    // 6. –í—Å—Ç–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫–∞–∑–∞ –≤ –ë–î
    if (pool && orderId) {
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∑–∞–∫–∞–∑–∞ –≤ –ë–î...');
      const itemInserts = cart.map(item => [
        orderId,
        item.product?.id,
        item.product?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä',
        item.qty,
        item.product?.price || 0
      ]);

      if (itemInserts.length > 0) {
        const queryText = 'INSERT INTO order_items (order_id, product_id, product_title, quantity, price_per_unit) VALUES ';
        const queryValues = [];
        const placeholders = itemInserts.map((_, index) => {
          const start = index * 5 + 1;
          return `($${start}, $${start+1}, $${start+2}, $${start+3}, $${start+4})`;
        }).join(', ');

        itemInserts.forEach(item => {
          queryValues.push(...item);
        });

        await pool.query(queryText + placeholders, queryValues);
        console.log('–ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î');
      }
    }

    // 7. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
    const message = `
üì¶ *–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ BIZON!*
üìû *–¢–µ–ª–µ—Ñ–æ–Ω:* \`${phone}\`
üí¨ *–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* ${comment || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üõí *–¢–æ–≤–∞—Ä—ã:*
${cart.map(item => `‚Ä¢ ${item.product?.title || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä'} √ó${item.qty} ‚Äî ${(item.product?.price || 0) * item.qty} ‚ÇΩ`).join('\n')}
üí∞ *–ò—Ç–æ–≥–æ:* ${total} ‚ÇΩ
üïê ${moscowTimeString}
`.trim();

    console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram:', message);

    // 8. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
    const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
    const CHAT_ID = process.env.TELEGRAM_CHAT_ID;

    if (BOT_TOKEN && CHAT_ID) {
      try {
        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram...');
        await axios.post(
          `https://api.telegram.org/bot ${BOT_TOKEN}/sendMessage`,
          {
            chat_id: CHAT_ID,
            text: message,
            parse_mode: 'Markdown',
            disable_web_page_preview: true
          }
        );
        telegramSent = true;
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram');
      } catch (telegramError) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', telegramError.message);
        // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ Telegram –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
      }
    } else {
      console.warn('–¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ –∏–ª–∏ ID —á–∞—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    }

    // 9. –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
    console.log('=== –ó–ê–ö–ê–ó –£–°–ü–ï–®–ù–û –û–ë–†–ê–ë–û–¢–ê–ù ===');
    res.json({ 
      success: true, 
      orderId: orderId,
      savedToDB: orderSaved,
      sentToTelegram: telegramSent
    });

  } catch (error) {
    console.error('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞:', error);
    // –û—á–∏—â–∞–µ–º —Ö—ç—à –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
    req.app.locals.lastOrderRequest = null;
    req.app.locals.lastOrderId = null;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    res.status(500).json({ success: false, error: '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ' });
  }
});

// === API: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID ===
app.get('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query(`
        SELECT 
          id, title, description, price, tag, available, category, brand, compatibility,
          images_json as images
        FROM products 
        WHERE id = $1
      `, [id]);

      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      res.json(result.rows[0]);
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä' });
  }
});

// === API: –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä ===
app.post('/api/products', async (req, res) => {
  try {
    const { title, description, price, tag, available, category, brand, compatibility, images } = req.body;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º images –æ–±—Ä–∞—Ç–Ω–æ –≤ JSON –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
    const images_json = images ? JSON.stringify(images) : null;

    if (pool) {
      const result = await pool.query(`
        INSERT INTO products (title, description, price, tag, available, category, brand, compatibility, images_json)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING id, title, description, price, tag, available, category, brand, compatibility, images_json as images
      `, [title, description, price, tag, available, category, brand, compatibility, images_json]);

      res.status(201).json(result.rows[0]);
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä' });
  }
});

// === API: –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä ===
app.put('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { title, description, price, tag, available, category, brand, compatibility, images } = req.body;
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º images –æ–±—Ä–∞—Ç–Ω–æ –≤ JSON –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
    const images_json = images ? JSON.stringify(images) : null;

    if (pool) {
      const result = await pool.query(`
        UPDATE products 
        SET title = $1, description = $2, price = $3, tag = $4, available = $5, category = $6, brand = $7, compatibility = $8, images_json = $9
        WHERE id = $10
        RETURNING id, title, description, price, tag, available, category, brand, compatibility, images_json as images
      `, [title, description, price, tag, available, category, brand, compatibility, images_json, id]);

      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      res.json(result.rows[0]);
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä' });
  }
});

// === API: –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä ===
app.delete('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query('DELETE FROM products WHERE id = $1 RETURNING id', [id]);
      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      res.status(204).send(); // 204 No Content - —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä' });
  }
});

// === API: –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ===
app.get('/api/categories', async (req, res) => {
  try {
    if (pool) {
      // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ categories —Å –ø–æ–ª—è–º–∏ id –∏ name
      const result = await pool.query('SELECT id, name FROM categories ORDER BY name');
      res.json(result.rows);
    } else {
      // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      console.warn('–¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ pool –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');
      res.json([]); // –ò–ª–∏ res.json([{id: 1, name: '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞'}, ...]);
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏' });
  }
});

// === API: –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ===
app.post('/api/categories', async (req, res) => {
    try {
        const { name } = req.body;
        if (!name) {
            return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
        }

        if (pool) {
            const result = await pool.query(
                'INSERT INTO categories (name) VALUES ($1) RETURNING id, name',
                [name]
            );
            res.status(201).json(result.rows[0]);
        } else {
            res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err);
        res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é' });
    }
});

// === API: –õ–æ–≥–∏–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ===
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    // 1. –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if (!username || !password) {
      return res.status(400).json({ success: false, message: '–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }

    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    if (!pool) {
      console.error('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
      return res.status(500).json({ success: false, message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
    }

    // 3. –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    const result = await pool.query(
      'SELECT id, username, password_hash FROM admin_users WHERE username = $1',
      [username]
    );

    // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (result.rows.length === 0) {
      // –í —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      return res.status(401).json({ success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
    }

    const user = result.rows[0];

    // 5. –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ö—ç—à –ø–∞—Ä–æ–ª—è
    const isPasswordValid = await bcrypt.compare(password, user.password_hash);
    
    if (!isPasswordValid) {
      return res.status(401).json({ success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
    }

    // 6. –ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã —Å–æ–∑–¥–∞–≤–∞–ª—Å—è JWT —Ç–æ–∫–µ–Ω
    res.json({ success: true, message: '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞' });

  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
    res.status(500).json({ success: false, message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏' });
  }
});

// === API: –£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ===
app.delete('/api/categories/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query('DELETE FROM categories WHERE id = $1 RETURNING id', [id]);
      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
      }
      res.status(204).send(); // 204 No Content - —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é' });
  }
});

// === API: –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑—ã ===
app.get('/api/orders', async (req, res) => {
  try {
    if (pool) {
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã
      const ordersResult = await pool.query(`
        SELECT 
          id, 
          phone, 
          comment, 
          total_amount, 
          created_at, 
          COALESCE(status, '–Ω–æ–≤—ã–π') as status
        FROM orders 
        ORDER BY created_at DESC
      `);

      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–∫–∞–∑–∞ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –ø–æ–∑–∏—Ü–∏–∏
      const ordersWithItems = await Promise.all(ordersResult.rows.map(async (order) => {
        const itemsResult = await pool.query(`
          SELECT 
            product_id,
            product_title, 
            quantity,
            price_per_unit, 
            (quantity * price_per_unit) as total_price 
          FROM order_items 
          WHERE order_id = $1
          ORDER BY id
        `, [order.id]);

        return {
          ...order,
          items: itemsResult.rows || [] // –ü–µ—Ä–µ–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å price_per_unit
        };
      }));

      res.json(ordersWithItems);
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã: ' + err.message });
  }
});

// === API: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ===
app.put('/api/orders/:id/status', async (req, res) => {
  try {
    const { id } = req.params;
    const { status } = req.body;

    // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞
    const validStatuses = ['–Ω–æ–≤—ã–π', '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ', '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', '–¥–æ—Å—Ç–∞–≤–ª–µ–Ω', '–æ—Ç–º–µ–Ω–µ–Ω'];
    if (!validStatuses.includes(status)) {
      return res.status(400).json({ error: '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Å—Ç–∞—Ç—É—Å' });
    }

    if (pool) {
      const result = await pool.query(
        'UPDATE orders SET status = $1 WHERE id = $2 RETURNING id',
        [status, id]
      );

      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }

      res.json({ success: true, message: '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω' });
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞' });
  }
});

// === API: –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ ===
app.delete('/api/orders/:id', async (req, res) => {
  try {
    const { id } = req.params;

    if (pool) {
      // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
      await pool.query('DELETE FROM order_items WHERE order_id = $1', [id]);
      
      // –ü–æ—Ç–æ–º —É–¥–∞–ª—è–µ–º —Å–∞–º –∑–∞–∫–∞–∑
      const result = await pool.query('DELETE FROM orders WHERE id = $1 RETURNING id', [id]);

      if (result.rows.length === 0) {
        return res.status(404).json({ error: '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }

      res.json({ success: true, message: '–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ' });
    } else {
      res.status(500).json({ error: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞' });
    }
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', err);
    res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑: ' + err.message });
  }
});

app.listen(PORT, () => {
  console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:${PORT}`);
});<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BIZON ‚Äî –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>

<link rel="icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">



<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

  <!-- Preconnect –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <link rel="preconnect" href="https://fonts.googleapis.com ">
  <link rel="preconnect" href="https://fonts.gstatic.com " crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ -->
  <link rel="stylesheet" href="css/base/reset.css">
  <link rel="stylesheet" href="css/layout/header.css">
  <link rel="stylesheet" href="css/components/background.css">
  <link rel="stylesheet" href="css/components/tags.css">
  <link rel="stylesheet" href="css/components/product-card.css">
  <link rel="stylesheet" href="css/components/modal.css">
  <link rel="stylesheet" href="css/components/cart.css">
  <link rel="stylesheet" href="css/layout/footer.css">
</head>
<body>

  <!-- –§–æ–Ω–æ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è -->
  <div class="bg-overlay" aria-hidden="true">
    <div class="pulse-1"></div>
    <div class="pulse-2"></div>
    <div class="pulse-3"></div>
  </div>

  <header class="header" role="banner">
  <div class="logo">
    <div class="logo-icon">
      <img src="assets/logo/logo-Photoroom.png" alt="–õ–æ–≥–æ—Ç–∏–ø BIZON" width="75" height="75">
    </div>
    <div class="logo-title">BIZON</div>
  </div>

  <nav class="main-nav" role="navigation" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
    <ul class="nav-list">
      <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
      <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
      <li><a href="about.html">–û –Ω–∞—Å</a></li>
      <li><a href="contact.html">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
    </ul>
  </nav>

  <div class="header-actions">
    <!-- –ü–æ–∏—Å–∫ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ catalog.html -->
    <div class="search" id="header-search">
       <svg 
      class="search-icon" 
      aria-hidden="true" 
      focusable="false" 
      viewBox="0 0 24 24" 
      stroke="currentColor" 
      fill="none" 
      stroke-width="2"
    >
      <path 
        stroke-linecap="round" 
        stroke-linejoin="round" 
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" 
      />
    </svg>
      <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º..." />
    </div>

    <button id="cart-btn" class="cart-btn" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
      
      –ö–æ—Ä–∑–∏–Ω–∞
      <span id="cart-count" class="cart-count">0</span>
    </button>
  </div>
</header>

  <main role="main">
   

   <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
<!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã JavaScript'–æ–º, –ø–æ—ç—Ç–æ–º—É –Ω–∞—á–∞–ª—å–Ω—ã–π HTML –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∑–∞–≥–ª—É—à–∫—É -->
<div class="tags" role="group" aria-label="–§–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º">
    <!-- –ö–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —Å–∫—Ä–∏–ø—Ç–æ–º -->
    <!-- <button class="tag-btn active" data-category="–≤—Å–µ">–≤—Å–µ</button> -->
    <!-- ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ... -->
</div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
    <div id="products" class="products" aria-live="polite" aria-atomic="true">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ö–æ—Ä–∑–∏–Ω–∞ -->
  <div id="cart-modal" class="modal" role="dialog" aria-labelledby="cart-modal-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="cart-modal-title" class="modal-title">–ö–æ—Ä–∑–∏–Ω–∞</h3>
        <button class="modal-close" data-close="cart" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
      </div>
      <div class="modal-body" id="cart-items">
        <div class="empty">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      </div>
      <div class="modal-footer">
        <label for="phone-input" class="visually-hidden">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏</label>
        <input type="tel" id="phone-input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏" required>

        <label for="comment-input" class="visually-hidden">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
        <textarea id="comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É"></textarea>

        <button id="send-order">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>

        <div id="success-message" class="success-message" role="alert" aria-live="assertive">
          ‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –¢–æ–≤–∞—Ä -->
  <div id="product-modal" class="modal" role="dialog" aria-labelledby="product-title" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">–¢–æ–≤–∞—Ä</h3>
        <button class="modal-close" data-close="product" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
      </div>
      <div class="product-modal-body">
        <div class="product-modal-left">
          <div class="product-modal-image">
            <img id="product-main-image" src="" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
          </div>
          <div class="product-thumbnails" id="thumbnails" role="group" aria-label="–ú–∏–Ω–∏–∞—Ç—é—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"></div>
        </div>
        <div class="product-modal-right">
          <div class="product-info">
            <h3 id="product-title" class="product-title"></h3>
            <p id="product-description" class="product-description"></p>
            <div id="product-price" class="product-price"></div>
          </div>
          <div class="buttons-container">
            <button id="add-to-cart-btn" class="btn-add full-width">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
            <button id="buy-now-btn" class="btn-buy full-width">–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥–≤–∞–ª -->
  <footer role="contentinfo">
    ¬© <span id="year"></span> BIZON ‚Äî –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã
  </footer>

  <!-- –°–∫—Ä–∏–ø—Ç—ã -->

  <script defer src="js/utils.js"></script>
  <script defer src="js/state.js"></script>
  <script defer src="js/ui.js"></script>
  <script defer src="js/main.js"></script>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
  <script>
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–æ–¥–∞
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>  —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —É –º–µ–Ω—è —Å–∞–π—Ç –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª–µ [Info] Successfully preconnected to https://fonts.googleapis.com/ 
[Info] Successfully preconnected to https://fonts.gstatic.com/ 
[Error] Failed to load resource: the server responded with a status of 404 (Not Found) (cart.js, line 0)
[Error] Refused to execute http://localhost:3000/js/cart.js as script because "X-Content-Type-Options: nosniff" was given and its Content-Type is not a script MIME type.
[Log] >>> [DEBUG] DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (state.js, line 85)
[Log] >>> [DEBUG] DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (main.js, line 7)
[Error] Unhandled Promise Rejection: ReferenceError: Can't find variable: loadCategoriesAndSetupFilters
	(–∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è) (main.js:15)
	(–∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è) (main.js:6)
[Error] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤: ‚Äì ReferenceError: Can't find variable: formatPrice ‚Äî ui.js:81
ReferenceError: Can't find variable: formatPrice ‚Äî ui.js:81
	(–∞–Ω–æ–Ω–∏–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è) (ui.js:116) –Ω–∞–¥–æ —á—Ç–æ–±—ã –±—ã–ª–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Ç–æ–≤–∞—Ä–∞