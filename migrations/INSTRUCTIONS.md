# Инструкция по применению миграции сессий

## Что изменилось

Сессии теперь хранятся в базе данных PostgreSQL вместо памяти сервера. Это решает проблему потери сессий при перезапуске сервера.

## Шаги для применения

### Вариант 1: Автоматическое применение (рекомендуется)

Запустите скрипт миграции:

```bash
node migrations/apply_migration.js
```

Скрипт автоматически:
- Создаст таблицу `sessions`
- Создаст необходимые индексы
- Проверит успешность создания

### Вариант 2: Ручное применение через psql

1. Подключитесь к вашей базе данных:
```bash
psql -U your_username -d your_database
```

2. Выполните SQL скрипт:
```sql
\i migrations/create_sessions_table.sql
```

Или скопируйте содержимое файла `migrations/create_sessions_table.sql` и выполните в вашем клиенте PostgreSQL.

### Вариант 3: Через любой SQL клиент

Откройте файл `migrations/create_sessions_table.sql` и выполните его содержимое в вашем SQL клиенте (pgAdmin, DBeaver, DataGrip и т.д.).

## Проверка

После применения миграции проверьте:

```sql
-- Проверка существования таблицы
SELECT * FROM information_schema.tables WHERE table_name = 'sessions';

-- Проверка структуры таблицы
\d sessions

-- Проверка индексов
SELECT indexname, indexdef FROM pg_indexes WHERE tablename = 'sessions';
```

Должны быть созданы:
- Таблица `sessions` с полями: `session_id`, `user_id`, `username`, `created_at`, `last_activity`, `expires_at`
- Индексы: `idx_sessions_session_id`, `idx_sessions_expires_at`, `idx_sessions_user_id`

## Что происходит после миграции

1. **При логине**: Сессия создается в БД с временем истечения (24 часа)
2. **При каждом запросе**: Проверяется валидность сессии в БД и обновляется `last_activity`
3. **При выходе**: Сессия удаляется из БД
4. **Автоматическая очистка**: Истекшие сессии удаляются каждые 30 минут и при старте сервера

## Откат (если нужно)

Если нужно вернуться к хранению в памяти (не рекомендуется):

1. Удалите таблицу:
```sql
DROP TABLE IF EXISTS sessions CASCADE;
```

2. Откатите изменения в `middleware/auth.js` (вернитесь к предыдущей версии с `Map()`)

## Важно

- **Все активные сессии будут потеряны** при применении миграции (пользователям нужно будет войти заново)
- **Рекомендуется применять миграцию** в период низкой активности или предупредить пользователей
- После миграции сессии **сохраняются при перезапуске сервера**

## Проблемы?

Если возникли проблемы:

1. Проверьте права доступа к БД (пользователь должен иметь права CREATE TABLE)
2. Проверьте, что таблица `admin_users` существует (сессии ссылаются на неё через FOREIGN KEY)
3. Проверьте логи сервера на наличие ошибок
