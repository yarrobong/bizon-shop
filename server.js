// server.js
require('dotenv').config();
const express = require('express');
const path = require('path');
const fs = require('fs');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

const bcrypt = require('bcryptjs');

app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));




// === ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Render) ===
let pool;
if (process.env.DATABASE_URL) {
  const { Pool } = require('pg');
  pool = new Pool({
    connectionString: process.env.DATABASE_URL,
    ssl: {
      rejectUnauthorized: false
    }
  });
}

// === API: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ ===
app.get('/api/products', async (req, res) => {
  try {
   
    if (pool) {
      // ÐÐ° Render â€” Ð¸Ð· Ð‘Ð”
      
      // ÐŸÑ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°Ñ, Ñ‡Ñ‚Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° products Ð¸Ð¼ÐµÐµÑ‚ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ¸: id, title, description, price, tag, available, category, brand, compatibility, images_json
      const result = await pool.query(`
        SELECT 
          id, title, description, price, tag, available, category, brand, compatibility,
          images_json as images -- ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ images_json Ð² images Ð´Ð»Ñ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
        FROM products 
        WHERE available = true 
        ORDER BY id
      `);
      
      res.json(result.rows); // Ð¢ÐµÐ¿ÐµÑ€ÑŒ ÐºÐ°Ð¶Ð´Ð°Ñ ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ð¾Ð»Ðµ 'images'
    } else {
      console.warn('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾ Ð¸Ð»Ð¸ pool Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½. Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ð¿ÑƒÑÑ‚Ð¾Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº.');
      res.json([]);
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹' });
  }
});

// === API: ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· ===
app.post('/api/order', async (req, res) => {
  const { phone, comment, cart } = req.body;

  // 1. Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
  if (!phone || !cart || cart.length === 0) {
    return res.status(400).json({ success: false, error: 'ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ…' });
  }

  // 2. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ‰ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ
  const total = cart.reduce((sum, item) => sum + (item.product?.price || 0) * item.qty, 0);

  // 3. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Telegram (ÐºÐ°Ðº Ñƒ Ð²Ð°Ñ Ð±Ñ‹Ð»Ð¾)
  const message = `
ðŸ“¦ *ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· Ð½Ð° BIZON!*
ðŸ“ž *Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:* \`${phone}\`
ðŸ’¬ *ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:* ${comment || 'Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½'}
ðŸ›’ *Ð¢Ð¾Ð²Ð°Ñ€Ñ‹:*
${cart.map(item => `â€¢ ${item.product?.title || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€'} Ã—${item.qty} â€” ${(item.product?.price || 0) * item.qty} â‚½`).join('\n')}
ðŸ’° *Ð˜Ñ‚Ð¾Ð³Ð¾:* ${total} â‚½
ðŸ• ${new Date().toLocaleString('ru-RU')}
  `.trim();

  // 4. ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸ÑŽ (ÐµÑÐ»Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾) Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
  // Ð’Ð°Ð¶Ð½Ð¾: Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð´Ð¾Ð»Ð¶Ð½Ð° Ð¾Ñ‚ÐºÐ°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ, ÐµÑÐ»Ð¸ Ñ‡Ð°ÑÑ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾
  try {
    let orderId = null;

    // 5. Ð’ÑÑ‚Ð°Ð²ÐºÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°ÐºÐ°Ð·Ðµ Ð² Ð‘Ð”
    if (pool) { // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”
     
        const orderResult = await pool.query(
          'INSERT INTO orders (phone, comment, total_amount) VALUES ($1, $2, $3) RETURNING id',
          [phone, comment || '', total]
        );
        orderId = orderResult.rows[0].id;
       
    } else {
        console.warn('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚. Ð—Ð°ÐºÐ°Ð· Ð½Ðµ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² Ð‘Ð”.');
    }

    // 6. Ð’ÑÑ‚Ð°Ð²ÐºÐ° Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹ Ð·Ð°ÐºÐ°Ð·Ð° Ð² Ð‘Ð”
    if (pool && orderId) {
       
        // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ batch insert
        const itemInserts = cart.map(item => [
            orderId,
            item.product?.id,
            item.product?.title || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€',
            item.qty,
            item.product?.price || 0
        ]);

        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ pg-format Ð¸Ð»Ð¸ ÑÑ‚Ñ€Ð¾Ð¸Ð¼ SQL Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð´Ð»Ñ batch insert
        // ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ñ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸ÐµÐ¼ SQL (Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¸Ñ‚ Ð´Ð»Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ð¾Ð±ÑŠÐµÐ¼Ð¾Ð²):
        if (itemInserts.length > 0) {
            const queryText = 'INSERT INTO order_items (order_id, product_id, product_title, quantity, price_per_unit) VALUES ';
            const queryValues = [];
            const placeholders = itemInserts.map((_, index) => {
                const start = index * 5 + 1;
                return `($${start}, $${start+1}, $${start+2}, $${start+3}, $${start+4})`;
            }).join(', ');

            itemInserts.forEach(item => {
                queryValues.push(...item);
            });

            await pool.query(queryText + placeholders, queryValues);
            
        }
    }

    // 7. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Telegram
   
    const BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
    const CHAT_ID = process.env.TELEGRAM_CHAT_ID;

    // Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ URL (ÑƒÐ±Ñ€Ð°Ð½ Ð»Ð¸ÑˆÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð±ÐµÐ»)
    await axios.post(
      `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,
      {
        chat_id: CHAT_ID,
        text: message,
        parse_mode: 'Markdown',
        disable_web_page_preview: true
      }
    );


    // 8. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ
    res.json({ success: true });

  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð·Ð°ÐºÐ°Ð·Ð°:', error);
    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ
    res.status(500).json({ success: false, error: 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð·Ð°ÐºÐ°Ð·Ð° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ' });
    // Ð’Ð°Ð¶Ð½Ð¾: Ð² production ÑÑ€ÐµÐ´Ðµ Ð½Ðµ ÑÑ‚Ð¾Ð¸Ñ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ¹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐµÑ€Ð²ÐµÑ€Ð°
  }
});
// server.js
// ... (Ð²ÑÑ‘, Ñ‡Ñ‚Ð¾ Ñƒ Ñ‚ÐµÐ±Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð²Ð²ÐµÑ€Ñ…Ñƒ Ñ„Ð°Ð¹Ð»Ð°)

// === API: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ Ð¿Ð¾ ID ===
app.get('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query(`
        SELECT 
          id, title, description, price, tag, available, category, brand, compatibility,
          images_json as images
        FROM products 
        WHERE id = $1
      `, [id]);

      if (result.rows.length === 0) {
        return res.status(404).json({ error: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
      }
      res.json(result.rows[0]);
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€' });
  }
});

// === API: Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ ===
app.post('/api/products', async (req, res) => {
  try {
    const { title, description, price, tag, available, category, brand, compatibility, images } = req.body;
    
    // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ images Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² JSON Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ð‘Ð”
    const images_json = images ? JSON.stringify(images) : null;

    if (pool) {
      const result = await pool.query(`
        INSERT INTO products (title, description, price, tag, available, category, brand, compatibility, images_json)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
        RETURNING id, title, description, price, tag, available, category, brand, compatibility, images_json as images
      `, [title, description, price, tag, available, category, brand, compatibility, images_json]);

      res.status(201).json(result.rows[0]);
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€' });
  }
});

// === API: ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ ===
app.put('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const { title, description, price, tag, available, category, brand, compatibility, images } = req.body;
    
    // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ images Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾ Ð² JSON Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ð‘Ð”
    const images_json = images ? JSON.stringify(images) : null;

    if (pool) {
      const result = await pool.query(`
        UPDATE products 
        SET title = $1, description = $2, price = $3, tag = $4, available = $5, category = $6, brand = $7, compatibility = $8, images_json = $9
        WHERE id = $10
        RETURNING id, title, description, price, tag, available, category, brand, compatibility, images_json as images
      `, [title, description, price, tag, available, category, brand, compatibility, images_json, id]);

      if (result.rows.length === 0) {
        return res.status(404).json({ error: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
      }
      res.json(result.rows[0]);
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€' });
  }
});

// === API: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€ ===
app.delete('/api/products/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query('DELETE FROM products WHERE id = $1 RETURNING id', [id]);
      if (result.rows.length === 0) {
        return res.status(404).json({ error: 'Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½' });
      }
      res.status(204).send(); // 204 No Content - ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð°:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€' });
  }
});

// === API: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ ===
app.get('/api/categories', async (req, res) => {
  try {
    if (pool) {
      // ÐŸÑ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° categories Ñ Ð¿Ð¾Ð»ÑÐ¼Ð¸ id Ð¸ name
      const result = await pool.query('SELECT id, name FROM categories ORDER BY name');
      res.json(result.rows);
    } else {
      // Ð•ÑÐ»Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð½ÐµÑ‚, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¼Ð°ÑÑÐ¸Ð² Ð¸Ð»Ð¸ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
      console.warn('Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¸Ð»Ð¸ pool Ð½Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½.');
      res.json([]); // Ð˜Ð»Ð¸ res.json([{id: 1, name: 'ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð¸ÐºÐ°'}, ...]);
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¹:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸' });
  }
});

// === API: Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ===
app.post('/api/categories', async (req, res) => {
    try {
        const { name } = req.body;
        if (!name) {
            return res.status(400).json({ error: 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾' });
        }

        if (pool) {
            const result = await pool.query(
                'INSERT INTO categories (name) VALUES ($1) RETURNING id, name',
                [name]
            );
            res.status(201).json(result.rows[0]);
        } else {
            res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
        }
    } catch (err) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:', err);
        res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ' });
    }
});

// === API: Ð›Ð¾Ð³Ð¸Ð½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° ===
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    // 1. Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
    if (!username || !password) {
      return res.status(400).json({ success: false, message: 'Ð›Ð¾Ð³Ð¸Ð½ Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹' });
    }

    // 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð”
    if (!pool) {
      console.error('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾');
      return res.status(500).json({ success: false, message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°' });
    }

    // 3. Ð˜Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð‘Ð”
    const result = await pool.query(
      'SELECT id, username, password_hash FROM admin_users WHERE username = $1',
      [username]
    );

    // 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ð°Ð¹Ð´ÐµÐ½ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
    if (result.rows.length === 0) {
      // Ð’ Ñ†ÐµÐ»ÑÑ… Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ñ€Ð°ÑÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
      return res.status(401).json({ success: false, message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    const user = result.rows[0];

    // 5. Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼ Ñ…ÑÑˆ Ð¿Ð°Ñ€Ð¾Ð»Ñ
    const isPasswordValid = await bcrypt.compare(password, user.password_hash);
    
    if (!isPasswordValid) {
      return res.status(401).json({ success: false, message: 'ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð»Ð¾Ð³Ð¸Ð½ Ð¸Ð»Ð¸ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ' });
    }

    // 6. Ð•ÑÐ»Ð¸ Ð²ÑÑ‘ Ð²ÐµÑ€Ð½Ð¾, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑ…
    // Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸ Ð·Ð´ÐµÑÑŒ Ð±Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ð»ÑÑ JWT Ñ‚Ð¾ÐºÐµÐ½
    res.json({ success: true, message: 'ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð°' });

  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸:', err);
    res.status(500).json({ success: false, message: 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð° Ð¿Ñ€Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸' });
  }
});

// === API: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ ===
app.delete('/api/categories/:id', async (req, res) => {
  try {
    const { id } = req.params;
    if (pool) {
      const result = await pool.query('DELETE FROM categories WHERE id = $1 RETURNING id', [id]);
      if (result.rows.length === 0) {
        return res.status(404).json({ error: 'ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°' });
      }
      res.status(204).send(); // 204 No Content - ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸:', err);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ' });
  }
});

// === API: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·Ñ‹ ===
app.get('/api/orders', async (req, res) => {
  try {
    if (pool) {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹ NULL Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹
      const result = await pool.query(`
        SELECT 
          o.id, 
          o.phone, 
          o.comment, 
          o.total_amount, 
          o.created_at, 
          o.status,
          COALESCE((
            SELECT json_agg(
              json_build_object(
                'product', json_build_object(
                  'id', oi.product_id, 
                  'title', oi.product_title, 
                  'price', oi.price_per_unit
                ), 
                'qty', oi.quantity
              )
            )
            FROM order_items oi 
            WHERE oi.order_id = o.id
          ), '[]') as cart
        FROM orders o
        ORDER BY o.created_at DESC
      `);
      
      // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð·Ð¸Ñ‚ÑŒ NULL Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
      const orders = result.rows.map(order => ({
        ...order,
        phone: order.phone || '',
        comment: order.comment || '',
        status: order.status || 'Ð½Ð¾Ð²Ñ‹Ð¹',
        cart: order.cart || []
      }));
      
      res.json(orders);
    } else {
      res.status(500).json({ error: 'Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð°' });
    }
  } catch (err) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð°ÐºÐ°Ð·Ð¾Ð²:', err);
    console.error('Stack trace:', err.stack);
    res.status(500).json({ error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·Ñ‹: ' + err.message });
  }
});

// ... (Ð²ÑÑ‘, Ñ‡Ñ‚Ð¾ Ñƒ Ñ‚ÐµÐ±Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð²Ð½Ð¸Ð·Ñƒ Ñ„Ð°Ð¹Ð»Ð°)


app.listen(PORT, () => {
  console.log(`âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:${PORT}`);
});